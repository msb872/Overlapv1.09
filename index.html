<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <link rel="icon" type="image/png" href="editedImage.png">

  <meta charset="UTF-8" />
  <title>Ø¯Ø±ØµØ¯ Ø¯Ø±Ú¯ÛŒØ±ÛŒ Ø¯Ø±Ø¨Ù†Ø¯ÛŒ Ù‚ÙˆØ·ÛŒ ÙÙ„Ø²ÛŒ - Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡</title>
  <style>
    body { font-family: Tahoma, sans-serif; background:#eef2f7; direction:rtl; margin:0; padding:6px; color:#333; }
    header { background:#0077b6; color:#fff; padding:8px; border-radius:6px; text-align:center; margin-bottom:10px; }
    .info-text{ font-size:12px; text-align:center; margin-bottom:10px; }
    .input-row{ display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-bottom:8px; }
    .input-row label{ font-size:12px; display:flex; flex-direction:column; width:140px; background:#fff; padding:10px; border:1px solid #ccc; border-radius:6px; }
    .input-row input,.input-row select{ margin-top:6px; padding:6px 8px; font-size:14px; border:1px solid #bbb; border-radius:4px; }
    .input-row button{ align-self:flex-end; background:#0077b6; border:none; color:#fff; padding:10px 20px; border-radius:6px; cursor:pointer; font-size:14px; margin-top:24px; width:140px; }
    .input-row button:hover{ background:#005f99; }
    .row-2selects{ display:flex; justify-content:center; gap:20px; margin-bottom:12px; flex-wrap:wrap; }
    .progress-bar-container{ width:90%; max-width:500px; margin:10px auto; background:#eee; border-radius:8px; overflow:hidden; height:18px; }
    .progress-bar{ height:100%; width:0%; background:linear-gradient(90deg,#0077b6,#00c4cc); transition:width .3s; }
    table{ width:100%; border-collapse:collapse; background:#fff; margin-top:10px; }
    th,td{ border:1px solid #555; padding:10px; text-align:center; font-size:14px; font-family:Tahoma, sans-serif; vertical-align:middle; }
    th{ background:#f0f4f8; }
    #warnings{ margin:10px 16px; font-family:Tahoma, sans-serif; }
    #warnings strong{ display:block; margin-bottom:4px; }
    #warnings div.warningItem{ background:#ffd2d2; padding:6px 10px; margin:4px 0; border-radius:6px; font-size:14px; line-height:1.3; text-align:justify; }
    #correctionMessage{ margin-top:10px; border-top:1px solid #999; padding-top:6px; font-size:14px; color:#0077b6; font-family:Tahoma, sans-serif; word-break:break-word; }
    #helpOverlay{ position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:1000; }
    #helpBox{ background:#fff; max-width:600px; width:90%; padding:20px; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,.3); text-align:right; line-height:1.6; position:relative; font-family:Tahoma, sans-serif; font-size:14px; color:#333; }
    #helpBox h4{ margin-top:0; color:#0077b6; text-align:center; }
    #helpBox h5{ color:#0077b6; margin-bottom:6px; margin-top:12px; }
    #helpCloseBtn{ position:absolute; top:8px; left:8px; padding:4px 8px; cursor:pointer; background:#0077b6; color:#fff; border:none; border-radius:4px; font-size:13px; }
    .footer-buttons{ position:fixed; bottom:10px; left:10px; display:flex; flex-direction:column; gap:8px; z-index:500; }
    .footer-buttons button{ background:#0077b6; border:none; color:#fff; padding:8px 12px; border-radius:6px; cursor:pointer; font-size:14px; width:140px; text-align:center; }
    .footer-buttons button:hover{ background:#005f99; }
    #pageFooter{ position:fixed; bottom:0; width:100%; background:#f1f1f1; text-align:center; padding:8px 0; font-size:14px; border-top:1px solid #ccc; font-family:Tahoma, sans-serif; }
    @media print{
      body *{ visibility:hidden; }
      #printArea, #printArea *, #warnings, #warnings *, #correctionMessage, #pageFooter, #printHeader, #printFooter{ visibility:visible !important; }
      #printArea{ position:absolute !important; top:0; left:0; width:100%; }
      .footer-buttons{ display:none !important; }
    }
    #printHeader{ display:flex; justify-content:space-between; margin-bottom:10px; font-size:14px; font-weight:bold; border-bottom:1px solid #999; padding-bottom:8px; visibility:hidden; font-family:Tahoma, sans-serif; }
    #printHeader div{ width:33%; text-align:center; }
    #printFooter{ text-align:center; font-size:12px; color:#666; margin-top:20px; border-top:1px solid #ccc; padding-top:8px; visibility:hidden; font-family:Tahoma, sans-serif; }
  </style>
</head>
<body>

<header>
  <h2>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±ØµØ¯ Ø¯Ø±Ú¯ÛŒØ±ÛŒ Ù‚ÙˆØ·ÛŒ ÙÙ„Ø²ÛŒ v1.12</h2>
  <p>ØªÙ‡ÛŒÙ‡â€ŒÚ©Ù†Ù†Ø¯Ù‡: Ù…ØµÛŒØ¨ Ø®Ø§Ù†ÛŒ - Ú©Ø§Ø±Ø´Ù†Ø§Ø³ Ú©Ù†ØªØ±Ù„ Ú©ÛŒÙÛŒØª Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ÛŒÚ© ÙˆÛŒÚ© Ø¯Ø´Øª Ù…Ø±ØºØ§Ø¨</p>
</header>

<p class="info-text" id="infoText">ğŸ”¹ ØªÙ…Ø§Ù… Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¨Ø± Ø­Ø³Ø¨ <strong>0.001 Ø§ÛŒÙ†Ú†</strong> Ù‡Ø³ØªÙ†Ø¯ ğŸ”¹</p>

<div class="row-2selects">
  <label>ğŸ“¦ Ù†ÙˆØ¹ Ø¸Ø±Ù:
    <select id="containerType">
      <option>Ø§Ù†ØªØ®Ø§Ø¨</option>
      <option>400g Ú†Ø§Ù¾Ø¯Ø§Ø±</option>
      <option>420g Ú†Ø§Ù¾Ø¯Ø§Ø±</option>
      <option>770g Ú†Ø§Ù¾Ø¯Ø§Ø±</option>
      <option>800g Ú†Ø§Ù¾Ø¯Ø§Ø±</option>
      <option>4000g Ú†Ø§Ù¾Ø¯Ø§Ø±</option>
      <option>16kg Ú†Ø§Ù¾Ø¯Ø§Ø±</option>
      <option>400g Ø³Ø§Ø¯Ù‡</option>
      <option>420g Ø³Ø§Ø¯Ù‡</option>
      <option>770g Ø³Ø§Ø¯Ù‡</option>
      <option>800g Ø³Ø§Ø¯Ù‡</option>
      <option>4000g Ø³Ø§Ø¯Ù‡</option>
      <option>16kg Ø³Ø§Ø¯Ù‡</option>
    </select>
  </label>
  <label>ğŸ“ ÙˆØ§Ø­Ø¯ ÙˆØ±ÙˆØ¯ÛŒ:
    <select id="unitSelect">
      <option value="thou">0.001 Ø§ÛŒÙ†Ú†</option>
      <option value="mm">Ù…ÛŒÙ„ÛŒÙ…ØªØ±</option>
    </select>
  </label>
</div>

<div class="input-row">
  <label>Ø·ÙˆÙ„-SL<input type="number" id="length" min="0" step="0.01" autocomplete="off"></label>
  <label>Ø¶Ø®Ø§Ù…Øª-ST<input type="number" id="seamThickness" min="0" step="0.01" autocomplete="off"></label>
  <label>Ù‚Ù„Ø§Ø¨ Ø¯Ø±Ø¨-CH<input type="number" id="coverHook" min="0" step="0.01" autocomplete="off"></label>
  <label>Ù‚Ù„Ø§Ø¨ Ø¨Ø¯Ù†Ù‡-BH<input type="number" id="bodyHook" min="0" step="0.01" autocomplete="off"></label>
  <label>Ø¶Ø®Ø§Ù…Øª Ø³Ø±-Te<input type="number" id="headThickness" min="0" step="0.01" autocomplete="off"></label>
  <label>Ø¶Ø®Ø§Ù…Øª Ø¨Ø¯Ù†Ù‡-Tb<input type="number" id="bodyThickness" min="0" step="0.01" autocomplete="off"></label>
  <button id="calcBtn" onclick="addTemplate()">â• Ù…Ø­Ø§Ø³Ø¨Ù‡/Ø¬Ø¯ÛŒØ¯</button>
</div>

<div class="progress-bar-container"><div class="progress-bar" id="progress"></div></div>

<div id="printArea">
  <div id="printHeader">
    <div>ğŸ“… ØªØ§Ø±ÛŒØ®: <span id="analysisDate"></span></div>
    <div>ğŸ“¦ Ø¸Ø±Ù: <span id="containerSelected"></span></div>
    <div>ğŸ‘¤ Ú©Ø§Ø±Ø´Ù†Ø§Ø³: <span id="reporterName"></span></div>
  </div>

  <table id="resultsTable" dir="rtl">
    <thead>
      <tr id="headerRow"><th>ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§</th></tr>
    </thead>
    <tbody id="tableBody">
      <tr><td>Ø·ÙˆÙ„ Ø¯ÙˆØ®Øª (SL)</td></tr>
      <tr><td>Ø¶Ø®Ø§Ù…Øª Ø¯ÙˆØ®Øª (ST)</td></tr>
      <tr><td>Ù‚Ù„Ø§Ø¨ Ø¯Ø±Ø¨ (CH)</td></tr>
      <tr><td>Ù‚Ù„Ø§Ø¨ Ø¨Ø¯Ù†Ù‡ (BH)</td></tr>
      <tr><td>Ø¶Ø®Ø§Ù…Øª Ø³Ø± (Te)</td></tr>
      <tr><td>Ø¶Ø®Ø§Ù…Øª Ø¨Ø¯Ù†Ù‡ (Tb)</td></tr>
      <tr><td>Ø§Ø®ØªÙ„Ø§Ù Ù‚Ù„Ø§Ø¨ (Î”H)</td></tr>
      <tr><td>ÙØ¶Ø§ÛŒ Ø¢Ø²Ø§Ø¯ (FS)</td></tr>
      <tr><td>Ø¯Ø±ØµØ¯ Ø¯Ø±Ú¯ÛŒØ±ÛŒ (OL%)</td></tr>
      <tr><td>Ú†Ø±ÙˆÚ©ÛŒØ¯Ú¯ÛŒ (Wr)</td></tr>
      <tr><td>ØªÛŒØ²Ú©Ø±Ø¯Ú¯ÛŒ (Sh)</td></tr>
    </tbody>
  </table>
</div>

<div id="warnings">
  <strong>âš ï¸ Ù…ÙˆØ§Ø±Ø¯ Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ø§ØµÙ„Ø§Ø­:</strong>
  <div id="warningList"></div>
  <div id="correctionMessage"></div>
</div>

<div class="footer-buttons">
  <button onclick="printReport()">ğŸ–¨ï¸ Ù¾Ø±ÛŒÙ†Øª</button>
  <button onclick="exportToExcel()">ğŸ“¤ Excel</button>
  <button onclick="saveAsHTML()">ğŸ’¾ HTML</button>
  <button onclick="showHelp()">â„¹ï¸ Ø±Ø§Ù‡Ù†Ù…Ø§</button>
</div>

<div id="helpOverlay">
  <div id="helpBox"></div>
</div>

<div id="pageFooter">
  Â© Û²Û°Û²Ûµ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ÛŒÚ©â€ŒÙˆâ€ŒÛŒÚ© | Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡: Ù…ØµÛŒØ¨ Ø®Ø§Ù†ÛŒ
</div>

<script>
let templatesData = [];
let isEditing = false;
let editingIndex = -1;
let correctionHistory = [];

const inputsOrder = ['length','seamThickness','coverHook','bodyHook','headThickness','bodyThickness'];

function toMM(thou){ return thou * 0.0254; }
function toThou(mm){ return mm / 0.0254; }

function formatVal(thou, unit){
  if(unit === 'mm'){
    const mm = toMM(thou);
    return mm.toFixed(2) + ' (mm)';
  } else {
    return thou.toFixed(2) + ' (thou)';
  }
}

function updateProgress(){
  const ins = inputsOrder.map(id => document.getElementById(id));
  const filled = ins.filter(i => i.value !== '').length;
  document.getElementById('progress').style.width = (filled / ins.length * 100) + '%';
}

document.querySelectorAll('.input-row input,.input-row select').forEach(i => {
  i.addEventListener('input', e => {
    if(e.target.id === 'unitSelect'){
      const unit = e.target.value;
      document.getElementById('infoText').innerHTML =
        unit === 'thou'
          ? 'ğŸ”¹ ØªÙ…Ø§Ù… Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¨Ø± Ø­Ø³Ø¨ <strong>0.001 Ø§ÛŒÙ†Ú†</strong> Ù‡Ø³ØªÙ†Ø¯ ğŸ”¹'
          : 'ğŸ”¹ ØªÙ…Ø§Ù… Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¨Ø± Ø­Ø³Ø¨ <strong>Ù…ÛŒÙ„ÛŒÙ…ØªØ±</strong> Ù‡Ø³ØªÙ†Ø¯ ğŸ”¹';
    }
    updateProgress();
  });
});

inputsOrder.forEach((id, i) => {
  const el = document.getElementById(id);
  el.addEventListener('keydown', e => {
    if(e.key === 'Enter'){
      e.preventDefault();
      if(i < inputsOrder.length - 1){
        document.getElementById(inputsOrder[i + 1]).focus();
      } else {
        document.getElementById('calcBtn').focus();
      }
    }
  });
});
document.getElementById('calcBtn').addEventListener('keydown', e => {
  if(e.key === 'Enter'){
    e.preventDefault();
    addTemplate();
  }
});

/* Ø¢Ø³ØªØ§Ù†Ù‡â€ŒÙ‡Ø§ (thou) */
const LIMITS_T = {
  CH_MIN: 70,
  BH_MIN: 70,
  DIFF_MAX: 7.8,
  FREE_MAX: 7.5,
  OL_MIN: 45
};

function addTemplate(){
  const unit = document.getElementById('unitSelect').value;

  // ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ â†’ thou
  let raw = inputsOrder.map(id => parseFloat(document.getElementById(id).value));
  if(raw.some(v => isNaN(v) || v < 0)){
    alert('Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    return;
  }
  if(unit === 'mm') raw = raw.map(v => toThou(v));
  const [L, ST, CH, BH, Te, Tb] = raw;

  const diff = Math.abs(CH - BH);
  const free = Math.abs(ST - (3*Te + 2*Tb));
  const denom = L - (2.2*Te + 1.1*Tb);
  const overlap = denom ? Math.abs((L - (CH + BH + 1.1*Te)) / denom * 100) : 0;

  /* --- Ø±ÙØªØ§Ø± Ø¬Ø¯ÛŒØ¯ Ø§ØµÙ„Ø§Ø­ÛŒÙ‡: Ù‡Ù…ÛŒØ´Ù‡ Ø³ØªÙˆÙ† Ø¬Ø¯ÛŒØ¯ --- */
  const newIndex = templatesData.length;            // Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø¯Ø§Ø¯Ù‡ ØªØ§Ø²Ù‡
  templatesData.push({L,ST,CH,BH,Te,Tb});

  const title = isEditing
    ? `Ø§ØµÙ„Ø§Ø­ÛŒÙ‡ Ù‚Ø§Ù„Ø¨ ${editingIndex + 1}`
    : `Ù‚Ø§Ù„Ø¨ ${countOriginals() + 1}`;

  // Ø³Ø§Ø®Øª Ø³Ø±Ø¨Ø±Ú¯ Ø³ØªÙˆÙ†
  const th = document.createElement('th');
  th.innerHTML = `${title}<br>
    <input type="checkbox" class="editCheck" data-idx="${newIndex}">
    <button class="del" style="margin-left:6px">Ø­Ø°Ù</button>`;
  document.getElementById('headerRow').appendChild(th);

  th.querySelector('.del').onclick = () => {
    const colIndex = [...document.getElementById('headerRow').children].indexOf(th);
    th.remove();
    document.querySelectorAll('#tableBody tr').forEach(r => {
      if(r.children[colIndex]) r.children[colIndex].remove();
    });
    correctionHistory = correctionHistory.filter(m => !m.startsWith(title));
    renderCorr();
    clearWarningList(title);
    isEditing = false; editingIndex = -1;
    document.getElementById('calcBtn').textContent = 'â• Ù…Ø­Ø§Ø³Ø¨Ù‡/Ø¬Ø¯ÛŒØ¯';
  };

  const colIndex = document.getElementById('headerRow').children.length - 1;

  // Ø¯Ø±Ø¬ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ø¬Ø¯ÙˆÙ„
  const vals = [L, ST, CH, BH, Te, Tb, diff, free, overlap, '-', '-'];
  addValuesToTable(colIndex, vals, unit);

  // Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ (Ù†Ù…Ø§ÛŒØ´ Ø¨Ø§ ÙˆØ§Ø­Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ)
  const warns = [];
  const mark = (row, msg) => {
    document.querySelectorAll('#tableBody tr')[row].children[colIndex].style.background = '#ffd2d2';
    warns.push(msg);
  };

  if (CH < LIMITS_T.CH_MIN) mark(2, `Ù‚Ù„Ø§Ø¨ Ø¯Ø±Ø¨ Ú©Ù…ØªØ± Ø§Ø² ${formatVal(LIMITS_T.CH_MIN, unit)}`);
  if (BH < LIMITS_T.BH_MIN) mark(3, `Ù‚Ù„Ø§Ø¨ Ø¨Ø¯Ù†Ù‡ Ú©Ù…ØªØ± Ø§Ø² ${formatVal(LIMITS_T.BH_MIN, unit)}`);
  if (diff > LIMITS_T.DIFF_MAX) mark(6, `Ø§Ø®ØªÙ„Ø§Ù Ù‚Ù„Ø§Ø¨ Ø¨ÛŒØ´ØªØ± Ø§Ø² ${formatVal(LIMITS_T.DIFF_MAX, unit)}`);
  if (free > LIMITS_T.FREE_MAX) mark(7, `ÙØ¶Ø§ÛŒ Ø¢Ø²Ø§Ø¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² ${formatVal(LIMITS_T.FREE_MAX, unit)}`);
  if (overlap < LIMITS_T.OL_MIN) mark(8, `Ø¯Ø±ØµØ¯ Ø¯Ø±Ú¯ÛŒØ±ÛŒ Ú©Ù…ØªØ± Ø§Ø² ${LIMITS_T.OL_MIN}%`);

  clearWarningList(title);
  if(warns.length > 0){
    addWarning(`${title}: ${warns.join(' Ø› ')}`);
  }
  correctionHistory.push(`${title}: ${warns.join(' Ø› ')}`);
  renderCorr();

  // Ø±ÛŒØ³Øª ÙØ±Ù… Ùˆ Ø­Ø§Ù„Øª Ø§ØµÙ„Ø§Ø­
  inputsOrder.forEach(id => document.getElementById(id).value = '');
  isEditing = false;
  editingIndex = -1;
  document.getElementById('calcBtn').textContent = 'â• Ù…Ø­Ø§Ø³Ø¨Ù‡/Ø¬Ø¯ÛŒØ¯';
  updateProgress();
}

/* Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ (Ù†Ù‡ Ø§ØµÙ„Ø§Ø­ÛŒÙ‡â€ŒÙ‡Ø§) Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¹Ù†ÙˆØ§Ù† Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ */
function countOriginals(){
  const ths = [...document.getElementById('headerRow').children];
  // Ø§ÙˆÙ„ÛŒÙ† th Ø¹Ù†ÙˆØ§Ù† "ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§" Ø§Ø³Øª
  let count = 0;
  for(let i=1;i<ths.length;i++){
    if(/^Ù‚Ø§Ù„Ø¨\s+\d+$/u.test(ths[i].textContent.trim().split('\n')[0])) count++;
  }
  return count;
}

function addValuesToTable(col, vals, unit){
  const rows = document.querySelectorAll('#tableBody tr');
  for(let i=0; i<vals.length; i++){
    let cell = rows[i].children[col];
    if(!cell){
      cell = document.createElement('td');
      rows[i].appendChild(cell);
    }
    const v = vals[i];
    if(typeof v === 'number'){
      if(i >= 9){ // Wr Ùˆ Sh
        cell.textContent = v;
      } else if(i === 8){ // Ø¯Ø±ØµØ¯ Ø¯Ø±Ú¯ÛŒØ±ÛŒ
        cell.textContent = v.toFixed(1) + ' (%)';
      } else {
        cell.textContent = formatVal(v, unit);
      }
    } else {
      cell.textContent = v;
    }
    cell.style.background = '';
  }
}

function addWarning(text){
  const div = document.createElement('div');
  div.className = 'warningItem';
  div.textContent = text;
  document.getElementById('warningList').appendChild(div);
}
function clearWarningList(templateTitle){
  const ul = document.getElementById('warningList');
  [...ul.children].forEach(child => {
    if(child.textContent.startsWith(templateTitle)) child.remove();
  });
}
function renderCorr(){
  document.getElementById('correctionMessage').textContent = correctionHistory.join(' | ');
}

// ÙˆÛŒØ±Ø§ÛŒØ´: ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù…Ø¨Ù†Ø§ØŒ Ø§Ù…Ø§ Ø«Ø¨Øª = Ø³ØªÙˆÙ† Ø¬Ø¯ÛŒØ¯
document.addEventListener('change', e => {
  if(e.target.classList.contains('editCheck')){
    if(e.target.checked){
      isEditing = true;
      editingIndex = +e.target.dataset.idx;
      loadTemplate(editingIndex);
      document.querySelectorAll('.editCheck').forEach(chk => { if(chk !== e.target) chk.checked = false; });
      document.getElementById('calcBtn').textContent = 'ğŸ“ Ø§ØµÙ„Ø§Ø­ Ù‚Ø§Ù„Ø¨';
      document.getElementById('calcBtn').focus();
    } else {
      isEditing = false;
      editingIndex = -1;
      clearInputs();
      document.getElementById('calcBtn').textContent = 'â• Ù…Ø­Ø§Ø³Ø¨Ù‡/Ø¬Ø¯ÛŒØ¯';
    }
  }
});

function loadTemplate(idx){
  const t = templatesData[idx];
  if(!t) return;
  const unit = document.getElementById('unitSelect').value;
  document.getElementById('length').value        = unit === 'mm' ? toMM(t.L).toFixed(2)  : t.L.toFixed(2);
  document.getElementById('seamThickness').value = unit === 'mm' ? toMM(t.ST).toFixed(2) : t.ST.toFixed(2);
  document.getElementById('coverHook').value     = unit === 'mm' ? toMM(t.CH).toFixed(2) : t.CH.toFixed(2);
  document.getElementById('bodyHook').value      = unit === 'mm' ? toMM(t.BH).toFixed(2) : t.BH.toFixed(2);
  document.getElementById('headThickness').value = unit === 'mm' ? toMM(t.Te).toFixed(2) : t.Te.toFixed(2);
  document.getElementById('bodyThickness').value = unit === 'mm' ? toMM(t.Tb).toFixed(2) : t.Tb.toFixed(2);
}
function clearInputs(){ inputsOrder.forEach(id => document.getElementById(id).value = ''); }

function printReport(){
  const name = prompt('Ù†Ø§Ù… Ú©Ø§Ø±Ø´Ù†Ø§Ø³', 'Ù…Ù‡Ù†Ø¯Ø³ Ø®Ø§Ù†ÛŒ') || 'Ù…Ù‡Ù†Ø¯Ø³ Ø®Ø§Ù†ÛŒ';
  document.getElementById('reporterName').textContent = name;
  document.getElementById('containerSelected').textContent = document.getElementById('containerType').value || '-';
  document.getElementById('analysisDate').textContent = new Date().toLocaleDateString('fa-IR');

  const hdr = document.getElementById('printHeader');
  const prevVis = hdr.style.visibility;
  hdr.style.visibility = 'visible';
  window.print();
  hdr.style.visibility = prevVis || 'hidden';
}

function exportToExcel(){
  const table = document.getElementById('resultsTable').outerHTML;
  const style = `
    <style>
      table, th, td{ border:1px solid #555; border-collapse:collapse; padding:6px; text-align:center; font-family:Tahoma, sans-serif; font-size:12pt; }
      th{ background-color:#f0f4f8; }
    </style>`;
  const html = `<!DOCTYPE html><html lang="fa" dir="rtl"><head><meta charset="UTF-8">${style}</head><body>${table}</body></html>`;
  const blob = new Blob([html], {type:'application/vnd.ms-excel'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'ØªØ­Ù„ÛŒÙ„_Ø¯Ø±Ú¯ÛŒØ±ÛŒ.xls'; a.click();
  URL.revokeObjectURL(url);
}

function saveAsHTML(){
  const name = prompt('Ù†Ø§Ù… Ú©Ø§Ø±Ø´Ù†Ø§Ø³', 'Ù…Ù‡Ù†Ø¯Ø³ Ø®Ø§Ù†ÛŒ') || 'Ù…Ù‡Ù†Ø¯Ø³ Ø®Ø§Ù†ÛŒ';
  const date = new Date().toLocaleDateString('fa-IR');
  const hdr = document.getElementById('printHeader');
  const prevVis = hdr.style.visibility;

  hdr.style.visibility = 'visible';
  document.getElementById('analysisDate').textContent = date;
  document.getElementById('reporterName').textContent = name;
  document.getElementById('containerSelected').textContent = document.getElementById('containerType').value || '-';

  const content = `
  <!DOCTYPE html>
  <html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>Ú¯Ø²Ø§Ø±Ø´ ØªØ­Ù„ÛŒÙ„ Ø¯Ø±Ú¯ÛŒØ±ÛŒ</title>
    <style>
      body{ font-family:Tahoma, sans-serif; direction:rtl; background:#fff; color:#333; margin:20px; }
      table{ width:100%; border-collapse:collapse; margin-bottom:15px; }
      th,td{ border:1px solid #555; padding:6px; text-align:center; font-size:14px; }
      th{ background-color:#f0f4f8; }
      #warnings{ margin-bottom:15px; }
      #correctionMessage{ font-size:14px; color:#0077b6; margin-top:10px; border-top:1px solid #999; padding-top:6px; }
      #pageFooter{ font-size:12px; color:#666; text-align:center; border-top:1px solid #ccc; padding-top:8px; }
    </style>
  </head>
  <body>
    ${document.getElementById('printArea').innerHTML}
    <div id="warnings">${document.getElementById('warnings').innerHTML}</div>
    <div id="correctionMessage">${document.getElementById('correctionMessage').innerHTML}</div>
    <div id="pageFooter">Â© Û²Û°Û²Ûµ Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ÛŒÚ©â€ŒÙˆâ€ŒÛŒÚ© | Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡: Ù…ØµÛŒØ¨ Ø®Ø§Ù†ÛŒ</div>
  </body>
  </html>`;

  const blob = new Blob([content], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `Ú¯Ø²Ø§Ø±Ø´_${date}.html`; a.click();
  URL.revokeObjectURL(url);

  hdr.style.visibility = prevVis || 'hidden';
}

function showHelp(){
  const helpHTML = `
<div style="font-family:Tahoma; direction:rtl; line-height:1.6; background:#f9f9f9; border-radius:10px; padding:15px; border:1px solid #ccc; max-width:600px; margin:auto;">
  <h2 style="color:#2c3e50; text-align:center;">ğŸ“˜ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ø±ÛŒØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯Ø±ØµØ¯ Ø¯Ø±Ú¯ÛŒØ±ÛŒ</h2>
  <p style="text-align:center; color:#555; font-size:14px;">
    Ø§ÛŒÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±ØµØ¯ Ø¯Ø±Ú¯ÛŒØ±ÛŒ (Overlap) Ùˆ Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø¯Ø±Ø¨Ù†Ø¯ÛŒ Ù‚ÙˆØ·ÛŒ ÙÙ„Ø²ÛŒ Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª.
  </p>

  <ol style="padding-right:20px; color:#333; font-size:14px;">
    <li><b>Ø§Ù†ØªØ®Ø§Ø¨ Ø¸Ø±Ù Ùˆ ÙˆØ§Ø­Ø¯:</b> Ù†ÙˆØ¹ Ù‚ÙˆØ·ÛŒ Ùˆ ÙˆØ§Ø­Ø¯ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ (Ù…ÛŒÙ„ÛŒÙ…ØªØ± ÛŒØ§ 0.001") Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</li>
    <li><b>ÙˆØ±ÙˆØ¯ Ù…Ù‚Ø§Ø¯ÛŒØ±:</b> Ø§Ø¹Ø¯Ø§Ø¯ SLØŒ STØŒ CHØŒ BHØŒ Te Ùˆ Tb Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù‡ Ùˆ Â«Ù…Ø­Ø§Ø³Ø¨Ù‡Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.</li>
    <li><b>Ù†ØªØ§ÛŒØ¬ Ùˆ Ù‡Ø´Ø¯Ø§Ø±:</b> Ø¯Ø±ØµØ¯ Ø¯Ø±Ú¯ÛŒØ±ÛŒ Ú©Ù…ØªØ± Ø§Ø² 45Ùª Ø¨Ø§ Ø±Ù†Ú¯ Ù‚Ø±Ù…Ø² Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ§Ø­Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø´Ù…Ø§ Ù‡Ø³ØªÙ†Ø¯.</li>
    <li><b>Ø§ØµÙ„Ø§Ø­ Ù‚Ø§Ù„Ø¨:</b> ØªÛŒÚ© Ù‚Ø§Ù„Ø¨ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯ØŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ Ùˆ Ø±ÙˆÛŒ Â«Ø§ØµÙ„Ø§Ø­ Ù‚Ø§Ù„Ø¨Â» Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯. Ù†ØªÛŒØ¬Ù‡ Ø¨Ø§ Ù†Ø§Ù… <span style="color:#2980b9;">Â«Ø§ØµÙ„Ø§Ø­ÛŒÙ‡ Ù‚Ø§Ù„Ø¨XÂ»</span> Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
    <li><b>Ù†Ú©ØªÙ‡ Ù…Ù‡Ù… ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„:</b> Ù¾Ø³ Ø§Ø² Ø°Ø®ÛŒØ±Ù‡ØŒ Ø±ÙˆÛŒ ÙØ§ÛŒÙ„ Ø±Ø§Ø³Øªâ€ŒÚ©Ù„ÛŒÚ© Ú©Ø±Ø¯Ù‡ Ùˆ Ú¯Ø²ÛŒÙ†Ù‡ <span style="color:#c0392b;">Unblock</span> Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯ ØªØ§ Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¨Ø§Ø² Ø´ÙˆØ¯.</li>
    <li><b>Ø®Ø±ÙˆØ¬ÛŒ:</b> Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø®Ø±ÙˆØ¬ÛŒ <span style="color:#27ae60;">Ù¾Ø±ÛŒÙ†Øª</span>ØŒ <span style="color:#27ae60;">Ø§Ú©Ø³Ù„</span> ÛŒØ§ HTML Ø¨Ú¯ÛŒØ±ÛŒØ¯ ÛŒØ§ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯.</li>
  </ol>

  <div style="background:#eef6ff; padding:10px; border-radius:8px; margin-top:10px; font-size:13px;">
    <b>ğŸ“ Ø­Ø¯ÙˆØ¯ Ù…Ø¬Ø§Ø²:</b><br>
    CH â‰¥ 1.78mm ØŒ BH â‰¥ 1.78mm ØŒ Î”H â‰¤ 0.20mm ØŒ FS â‰¤ 0.19mm ØŒ OL% â‰¥ 45%<br>
    <span style="color:#777;">ÙˆØ§Ø­Ø¯ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ§Ø­Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø´Ù…Ø§ Ø§Ø³Øª.</span>
  </div>

  <div style="background:#fff4e5; padding:10px; border-radius:8px; margin-top:10px; font-size:13px;">
    <b>ğŸ’¡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ùˆ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ:</b><br>
    Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ØŒ Ø§Ù†ØªÙ‚Ø§Ø¯ ÛŒØ§ Ø³ÙˆØ§Ù„ Ø¨Ø§ Ù…Ø§ Ø¯Ø± ØªÙ…Ø§Ø³ Ø¨Ø§Ø´ÛŒØ¯:<br>
    ğŸ“§ <a href="mailto:mosayeb872@gmail.com" style="color:#d35400;">mosayeb872@gmail.com</a><br>
    ğŸ“ <span style="color:#27ae60;">0912-320-6052</span>
  </div>

  <p style="text-align:center; margin-top:10px; font-size:12px; color:#777;">
    Â© Û²Û°Û²Ûµ- Ú©Ø§Ø±Ø®Ø§Ù†Ù‡ ÛŒÚ© ÙˆÛŒÚ© Ø¯Ø´Øª Ù…Ø±ØºØ§Ø¨ - Ù…ØµÛŒØ¨ Ø®Ø§Ù†ÛŒ
  </p>
  <div style="text-align:center;">
    <button id="helpCloseBtn" style="padding:8px 15px; border:none; background:#3498db; color:white; border-radius:5px; cursor:pointer;">Ø¨Ø³ØªÙ†</button>
  </div>
</div>

  `;
  const helpBox = document.getElementById('helpBox');
  helpBox.innerHTML = helpHTML;
  document.getElementById('helpOverlay').style.display = 'flex';
  document.getElementById('helpCloseBtn').onclick = () => {
    document.getElementById('helpOverlay').style.display = 'none';
  };
}

updateProgress();
</script>

</body>
</html>



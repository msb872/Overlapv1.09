
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>درصد درگیری دربندی قوطی فلزی - نسخه اصلاح شده</title>
  <style>
    body { font-family: Tahoma, sans-serif; background:#eef2f7; direction:rtl; margin:0; padding:6px; color:#333; }
    header { background:#0077b6; color:#fff; padding:8px; border-radius:6px; text-align:center; margin-bottom:10px; }
    .info-text{ font-size:12px; text-align:center; margin-bottom:10px; }
    .input-row{ display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-bottom:8px; }
    .input-row label{ font-size:12px; display:flex; flex-direction:column; width:140px; background:#fff; padding:10px; border:1px solid #ccc; border-radius:6px; }
    .input-row input,.input-row select{ margin-top:6px; padding:6px 8px; font-size:14px; border:1px solid #bbb; border-radius:4px; }
    .input-row button{ align-self:flex-end; background:#0077b6; border:none; color:#fff; padding:10px 20px; border-radius:6px; cursor:pointer; font-size:14px; margin-top:24px; width:140px; }
    .input-row button:hover{ background:#005f99; }
    .row-2selects{ display:flex; justify-content:center; gap:20px; margin-bottom:12px; flex-wrap:wrap; }
    .progress-bar-container{ width:90%; max-width:500px; margin:10px auto; background:#eee; border-radius:8px; overflow:hidden; height:18px; }
    .progress-bar{ height:100%; width:0%; background:linear-gradient(90deg,#0077b6,#00c4cc); transition:width .3s; }
    table{ width:100%; border-collapse:collapse; background:#fff; margin-top:10px; }
    th,td{ border:1px solid #555; padding:10px; text-align:center; font-size:14px; font-family:Tahoma, sans-serif; vertical-align:middle; }
    th{ background:#f0f4f8; }
    #warnings{ margin:10px 16px; font-family:Tahoma, sans-serif; }
    #warnings strong{ display:block; margin-bottom:4px; }
    #warnings div.warningItem{ background:#ffd2d2; padding:6px 10px; margin:4px 0; border-radius:6px; font-size:14px; line-height:1.3; text-align:justify; }
    #correctionMessage{ margin-top:10px; border-top:1px solid #999; padding-top:6px; font-size:14px; color:#0077b6; font-family:Tahoma, sans-serif; word-break:break-word; }
    #helpOverlay{ position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:1000; }
    #helpBox{ background:#fff; max-width:600px; width:90%; padding:20px; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,.3); text-align:right; line-height:1.6; position:relative; font-family:Tahoma, sans-serif; font-size:14px; color:#333; }
    #helpBox h4{ margin-top:0; color:#0077b6; text-align:center; }
    #helpBox h5{ color:#0077b6; margin-bottom:6px; margin-top:12px; }
    #helpCloseBtn{ position:absolute; top:8px; left:8px; padding:4px 8px; cursor:pointer; background:#0077b6; color:#fff; border:none; border-radius:4px; font-size:13px; }
    .footer-buttons{ position:fixed; bottom:10px; left:10px; display:flex; flex-direction:column; gap:8px; z-index:500; }
    .footer-buttons button{ background:#0077b6; border:none; color:#fff; padding:8px 12px; border-radius:6px; cursor:pointer; font-size:14px; width:140px; text-align:center; }
    .footer-buttons button:hover{ background:#005f99; }
    #pageFooter{ position:fixed; bottom:0; width:100%; background:#f1f1f1; text-align:center; padding:8px 0; font-size:14px; border-top:1px solid #ccc; font-family:Tahoma, sans-serif; }
    @media print{
      body *{ visibility:hidden; }
      #printArea, #printArea *, #warnings, #warnings *, #correctionMessage, #pageFooter, #printHeader, #printFooter{ visibility:visible !important; }
      #printArea{ position:absolute !important; top:0; left:0; width:100%; }
      .footer-buttons{ display:none !important; }
    }
    #printHeader{ display:flex; justify-content:space-between; margin-bottom:10px; font-size:14px; font-weight:bold; border-bottom:1px solid #999; padding-bottom:8px; visibility:hidden; font-family:Tahoma, sans-serif; }
    #printHeader div{ width:33%; text-align:center; }
    #printFooter{ text-align:center; font-size:12px; color:#666; margin-top:20px; border-top:1px solid #ccc; padding-top:8px; visibility:hidden; font-family:Tahoma, sans-serif; }
  </style>
</head>
<body>

<header>
  <h2>برنامه محاسبه درصد درگیری قوطی فلزی v1.12</h2>
  <p>تهیه‌کننده: مصیب خانی - کارشناس کنترل کیفیت کارخانه یک ویک دشت مرغاب</p>
</header>

<p class="info-text" id="infoText">🔹 تمام مقادیر بر حسب <strong>0.001 اینچ</strong> هستند 🔹</p>

<div class="row-2selects">
  <label>📦 نوع ظرف:
    <select id="containerType">
      <option>انتخاب</option>
      <option>400g چاپدار</option>
      <option>420g چاپدار</option>
      <option>770g چاپدار</option>
      <option>800g چاپدار</option>
      <option>4000g چاپدار</option>
      <option>16kg چاپدار</option>
      <option>400g ساده</option>
      <option>420g ساده</option>
      <option>770g ساده</option>
      <option>800g ساده</option>
      <option>4000g ساده</option>
      <option>16kg ساده</option>
    </select>
  </label>
  <label>📐 واحد ورودی:
    <select id="unitSelect">
      <option value="thou">0.001 اینچ</option>
      <option value="mm">میلیمتر</option>
    </select>
  </label>
</div>

<div class="input-row">
  <label>طول-SL<input type="number" id="length" min="0" step="0.01" autocomplete="off"></label>
  <label>ضخامت-ST<input type="number" id="seamThickness" min="0" step="0.01" autocomplete="off"></label>
  <label>قلاب درب-CH<input type="number" id="coverHook" min="0" step="0.01" autocomplete="off"></label>
  <label>قلاب بدنه-BH<input type="number" id="bodyHook" min="0" step="0.01" autocomplete="off"></label>
  <label>ضخامت سر-Te<input type="number" id="headThickness" min="0" step="0.01" autocomplete="off"></label>
  <label>ضخامت بدنه-Tb<input type="number" id="bodyThickness" min="0" step="0.01" autocomplete="off"></label>
  <button id="calcBtn" onclick="addTemplate()">➕ محاسبه/جدید</button>
</div>

<div class="progress-bar-container"><div class="progress-bar" id="progress"></div></div>

<div id="printArea">
  <div id="printHeader">
    <div>📅 تاریخ: <span id="analysisDate"></span></div>
    <div>📦 ظرف: <span id="containerSelected"></span></div>
    <div>👤 کارشناس: <span id="reporterName"></span></div>
  </div>

  <table id="resultsTable" dir="rtl">
    <thead>
      <tr id="headerRow"><th>ویژگی‌ها</th></tr>
    </thead>
    <tbody id="tableBody">
      <tr><td>طول دوخت (SL)</td></tr>
      <tr><td>ضخامت دوخت (ST)</td></tr>
      <tr><td>قلاب درب (CH)</td></tr>
      <tr><td>قلاب بدنه (BH)</td></tr>
      <tr><td>ضخامت سر (Te)</td></tr>
      <tr><td>ضخامت بدنه (Tb)</td></tr>
      <tr><td>اختلاف قلاب (ΔH)</td></tr>
      <tr><td>فضای آزاد (FS)</td></tr>
      <tr><td>درصد درگیری (OL%)</td></tr>
      <tr><td>چروکیدگی (Wr)</td></tr>
      <tr><td>تیزکردگی (Sh)</td></tr>
    </tbody>
  </table>
</div>

<div id="warnings">
  <strong>⚠️ موارد نیازمند اصلاح:</strong>
  <div id="warningList"></div>
  <div id="correctionMessage"></div>
</div>

<div class="footer-buttons">
  <button onclick="printReport()">🖨️ پرینت</button>
  <button onclick="exportToExcel()">📤 Excel</button>
  <button onclick="saveAsHTML()">💾 HTML</button>
  <button onclick="showHelp()">ℹ️ راهنما</button>
</div>

<div id="helpOverlay">
  <div id="helpBox"></div>
</div>

<div id="pageFooter">
  © ۲۰۲۵ کارخانه یک‌و‌یک | نویسنده: مصیب خانی
</div>

<script>
let templatesData = [];
let isEditing = false;
let editingIndex = -1;
let correctionHistory = [];

const inputsOrder = ['length','seamThickness','coverHook','bodyHook','headThickness','bodyThickness'];

function toMM(thou){ return thou * 0.0254; }
function toThou(mm){ return mm / 0.0254; }

function formatVal(thou, unit){
  if(unit === 'mm'){
    const mm = toMM(thou);
    return mm.toFixed(2) + ' (mm)';
  } else {
    return thou.toFixed(2) + ' (thou)';
  }
}

function updateProgress(){
  const ins = inputsOrder.map(id => document.getElementById(id));
  const filled = ins.filter(i => i.value !== '').length;
  document.getElementById('progress').style.width = (filled / ins.length * 100) + '%';
}

document.querySelectorAll('.input-row input,.input-row select').forEach(i => {
  i.addEventListener('input', e => {
    if(e.target.id === 'unitSelect'){
      const unit = e.target.value;
      document.getElementById('infoText').innerHTML =
        unit === 'thou'
          ? '🔹 تمام مقادیر بر حسب <strong>0.001 اینچ</strong> هستند 🔹'
          : '🔹 تمام مقادیر بر حسب <strong>میلیمتر</strong> هستند 🔹';
    }
    updateProgress();
  });
});

inputsOrder.forEach((id, i) => {
  const el = document.getElementById(id);
  el.addEventListener('keydown', e => {
    if(e.key === 'Enter'){
      e.preventDefault();
      if(i < inputsOrder.length - 1){
        document.getElementById(inputsOrder[i + 1]).focus();
      } else {
        document.getElementById('calcBtn').focus();
      }
    }
  });
});
document.getElementById('calcBtn').addEventListener('keydown', e => {
  if(e.key === 'Enter'){
    e.preventDefault();
    addTemplate();
  }
});

/* آستانه‌ها (thou) */
const LIMITS_T = {
  CH_MIN: 70,
  BH_MIN: 70,
  DIFF_MAX: 7.8,
  FREE_MAX: 7.5,
  OL_MIN: 45
};

function addTemplate(){
  const unit = document.getElementById('unitSelect').value;

  // ورودی‌ها → thou
  let raw = inputsOrder.map(id => parseFloat(document.getElementById(id).value));
  if(raw.some(v => isNaN(v) || v < 0)){
    alert('لطفاً همه مقادیر را به درستی وارد کنید');
    return;
  }
  if(unit === 'mm') raw = raw.map(v => toThou(v));
  const [L, ST, CH, BH, Te, Tb] = raw;

  const diff = Math.abs(CH - BH);
  const free = Math.abs(ST - (3*Te + 2*Tb));
  const denom = L - (2.2*Te + 1.1*Tb);
  const overlap = denom ? Math.abs((L - (CH + BH + 1.1*Te)) / denom * 100) : 0;

  /* --- رفتار جدید اصلاحیه: همیشه ستون جدید --- */
  const newIndex = templatesData.length;            // ایندکس داده تازه
  templatesData.push({L,ST,CH,BH,Te,Tb});

  const title = isEditing
    ? `اصلاحیه قالب ${editingIndex + 1}`
    : `قالب ${countOriginals() + 1}`;

  // ساخت سربرگ ستون
  const th = document.createElement('th');
  th.innerHTML = `${title}<br>
    <input type="checkbox" class="editCheck" data-idx="${newIndex}">
    <button class="del" style="margin-left:6px">حذف</button>`;
  document.getElementById('headerRow').appendChild(th);

  th.querySelector('.del').onclick = () => {
    const colIndex = [...document.getElementById('headerRow').children].indexOf(th);
    th.remove();
    document.querySelectorAll('#tableBody tr').forEach(r => {
      if(r.children[colIndex]) r.children[colIndex].remove();
    });
    correctionHistory = correctionHistory.filter(m => !m.startsWith(title));
    renderCorr();
    clearWarningList(title);
    isEditing = false; editingIndex = -1;
    document.getElementById('calcBtn').textContent = '➕ محاسبه/جدید';
  };

  const colIndex = document.getElementById('headerRow').children.length - 1;

  // درج داده‌ها در جدول
  const vals = [L, ST, CH, BH, Te, Tb, diff, free, overlap, '-', '-'];
  addValuesToTable(colIndex, vals, unit);

  // هشدارها (نمایش با واحد انتخابی)
  const warns = [];
  const mark = (row, msg) => {
    document.querySelectorAll('#tableBody tr')[row].children[colIndex].style.background = '#ffd2d2';
    warns.push(msg);
  };

  if (CH < LIMITS_T.CH_MIN) mark(2, `قلاب درب کمتر از ${formatVal(LIMITS_T.CH_MIN, unit)}`);
  if (BH < LIMITS_T.BH_MIN) mark(3, `قلاب بدنه کمتر از ${formatVal(LIMITS_T.BH_MIN, unit)}`);
  if (diff > LIMITS_T.DIFF_MAX) mark(6, `اختلاف قلاب بیشتر از ${formatVal(LIMITS_T.DIFF_MAX, unit)}`);
  if (free > LIMITS_T.FREE_MAX) mark(7, `فضای آزاد بیشتر از ${formatVal(LIMITS_T.FREE_MAX, unit)}`);
  if (overlap < LIMITS_T.OL_MIN) mark(8, `درصد درگیری کمتر از ${LIMITS_T.OL_MIN}%`);

  clearWarningList(title);
  if(warns.length > 0){
    addWarning(`${title}: ${warns.join(' ؛ ')}`);
  }
  correctionHistory.push(`${title}: ${warns.join(' ؛ ')}`);
  renderCorr();

  // ریست فرم و حالت اصلاح
  inputsOrder.forEach(id => document.getElementById(id).value = '');
  isEditing = false;
  editingIndex = -1;
  document.getElementById('calcBtn').textContent = '➕ محاسبه/جدید';
  updateProgress();
}

/* شمارنده قالب‌های اصلی (نه اصلاحیه‌ها) بر اساس عنوان ستون‌ها */
function countOriginals(){
  const ths = [...document.getElementById('headerRow').children];
  // اولین th عنوان "ویژگی‌ها" است
  let count = 0;
  for(let i=1;i<ths.length;i++){
    if(/^قالب\s+\d+$/u.test(ths[i].textContent.trim().split('\n')[0])) count++;
  }
  return count;
}

function addValuesToTable(col, vals, unit){
  const rows = document.querySelectorAll('#tableBody tr');
  for(let i=0; i<vals.length; i++){
    let cell = rows[i].children[col];
    if(!cell){
      cell = document.createElement('td');
      rows[i].appendChild(cell);
    }
    const v = vals[i];
    if(typeof v === 'number'){
      if(i >= 9){ // Wr و Sh
        cell.textContent = v;
      } else if(i === 8){ // درصد درگیری
        cell.textContent = v.toFixed(1) + ' (%)';
      } else {
        cell.textContent = formatVal(v, unit);
      }
    } else {
      cell.textContent = v;
    }
    cell.style.background = '';
  }
}

function addWarning(text){
  const div = document.createElement('div');
  div.className = 'warningItem';
  div.textContent = text;
  document.getElementById('warningList').appendChild(div);
}
function clearWarningList(templateTitle){
  const ul = document.getElementById('warningList');
  [...ul.children].forEach(child => {
    if(child.textContent.startsWith(templateTitle)) child.remove();
  });
}
function renderCorr(){
  document.getElementById('correctionMessage').textContent = correctionHistory.join(' | ');
}

// ویرایش: فقط برای بارگذاری مقادیر مبنا، اما ثبت = ستون جدید
document.addEventListener('change', e => {
  if(e.target.classList.contains('editCheck')){
    if(e.target.checked){
      isEditing = true;
      editingIndex = +e.target.dataset.idx;
      loadTemplate(editingIndex);
      document.querySelectorAll('.editCheck').forEach(chk => { if(chk !== e.target) chk.checked = false; });
      document.getElementById('calcBtn').textContent = '📝 اصلاح قالب';
      document.getElementById('calcBtn').focus();
    } else {
      isEditing = false;
      editingIndex = -1;
      clearInputs();
      document.getElementById('calcBtn').textContent = '➕ محاسبه/جدید';
    }
  }
});

function loadTemplate(idx){
  const t = templatesData[idx];
  if(!t) return;
  const unit = document.getElementById('unitSelect').value;
  document.getElementById('length').value        = unit === 'mm' ? toMM(t.L).toFixed(2)  : t.L.toFixed(2);
  document.getElementById('seamThickness').value = unit === 'mm' ? toMM(t.ST).toFixed(2) : t.ST.toFixed(2);
  document.getElementById('coverHook').value     = unit === 'mm' ? toMM(t.CH).toFixed(2) : t.CH.toFixed(2);
  document.getElementById('bodyHook').value      = unit === 'mm' ? toMM(t.BH).toFixed(2) : t.BH.toFixed(2);
  document.getElementById('headThickness').value = unit === 'mm' ? toMM(t.Te).toFixed(2) : t.Te.toFixed(2);
  document.getElementById('bodyThickness').value = unit === 'mm' ? toMM(t.Tb).toFixed(2) : t.Tb.toFixed(2);
}
function clearInputs(){ inputsOrder.forEach(id => document.getElementById(id).value = ''); }

function printReport(){
  const name = prompt('نام کارشناس', 'مهندس خانی') || 'مهندس خانی';
  document.getElementById('reporterName').textContent = name;
  document.getElementById('containerSelected').textContent = document.getElementById('containerType').value || '-';
  document.getElementById('analysisDate').textContent = new Date().toLocaleDateString('fa-IR');

  const hdr = document.getElementById('printHeader');
  const prevVis = hdr.style.visibility;
  hdr.style.visibility = 'visible';
  window.print();
  hdr.style.visibility = prevVis || 'hidden';
}

function exportToExcel(){
  const table = document.getElementById('resultsTable').outerHTML;
  const style = `
    <style>
      table, th, td{ border:1px solid #555; border-collapse:collapse; padding:6px; text-align:center; font-family:Tahoma, sans-serif; font-size:12pt; }
      th{ background-color:#f0f4f8; }
    </style>`;
  const html = `<!DOCTYPE html><html lang="fa" dir="rtl"><head><meta charset="UTF-8">${style}</head><body>${table}</body></html>`;
  const blob = new Blob([html], {type:'application/vnd.ms-excel'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'تحلیل_درگیری.xls'; a.click();
  URL.revokeObjectURL(url);
}

function saveAsHTML(){
  const name = prompt('نام کارشناس', 'مهندس خانی') || 'مهندس خانی';
  const date = new Date().toLocaleDateString('fa-IR');
  const hdr = document.getElementById('printHeader');
  const prevVis = hdr.style.visibility;

  hdr.style.visibility = 'visible';
  document.getElementById('analysisDate').textContent = date;
  document.getElementById('reporterName').textContent = name;
  document.getElementById('containerSelected').textContent = document.getElementById('containerType').value || '-';

  const content = `
  <!DOCTYPE html>
  <html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>گزارش تحلیل درگیری</title>
    <style>
      body{ font-family:Tahoma, sans-serif; direction:rtl; background:#fff; color:#333; margin:20px; }
      table{ width:100%; border-collapse:collapse; margin-bottom:15px; }
      th,td{ border:1px solid #555; padding:6px; text-align:center; font-size:14px; }
      th{ background-color:#f0f4f8; }
      #warnings{ margin-bottom:15px; }
      #correctionMessage{ font-size:14px; color:#0077b6; margin-top:10px; border-top:1px solid #999; padding-top:6px; }
      #pageFooter{ font-size:12px; color:#666; text-align:center; border-top:1px solid #ccc; padding-top:8px; }
    </style>
  </head>
  <body>
    ${document.getElementById('printArea').innerHTML}
    <div id="warnings">${document.getElementById('warnings').innerHTML}</div>
    <div id="correctionMessage">${document.getElementById('correctionMessage').innerHTML}</div>
    <div id="pageFooter">© ۲۰۲۵ کارخانه یک‌و‌یک | نویسنده: مصیب خانی</div>
  </body>
  </html>`;

  const blob = new Blob([content], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `گزارش_${date}.html`; a.click();
  URL.revokeObjectURL(url);

  hdr.style.visibility = prevVis || 'hidden';
}

function showHelp(){
  const helpHTML = `
    <h5>راهنمای استفاده از برنامه</h5>
    <p>این برنامه جهت محاسبه درصد درگیری دربندی قوطی فلزی طراحی شده است.</p>
    <h5>۱. نحوه وارد کردن داده‌ها</h5>
    <ul>
      <li>مقادیر طول، ضخامت، قلاب‌ها و ... را وارد کنید.</li>
      <li>واحد ورودی می‌تواند 0.001 اینچ یا میلیمتر باشد.</li>
    </ul>
    <h5>۲. محاسبه و اصلاح قالب</h5>
    <ul>
      <li>روی دکمه محاسبه کلیک کنید یا Enter را در آخرین فیلد فشار دهید.</li>
      <li>برای اصلاح، تیک کنار قالب اصلی را بزنید تا مقادیر آن در فرم بیاید؛ سپس «📝 اصلاح قالب» را بزنید تا ستون جدید با عنوان «اصلاحیه قالب X» ساخته شود.</li>
    </ul>
    <h5>۳. ذخیره و خروجی‌ها</h5>
    <ul>
      <li>امکان پرینت جداول و پیام‌های هشدار.</li>
      <li>امکان خروجی Excel با استایل مناسب.</li>
      <li>ذخیره گزارش به صورت HTML (جدول و پیام‌ها).</li>
    </ul>
    <h5>۴. آستانه‌ها</h5>
    <ul>
      <li>قلاب‌ها ≥ ${formatVal(LIMITS_T.CH_MIN,'thou')} (~${formatVal(LIMITS_T.CH_MIN,'mm')})</li>
      <li>اختلاف قلاب ≤ ${formatVal(LIMITS_T.DIFF_MAX,'thou')} (~${formatVal(LIMITS_T.DIFF_MAX,'mm')})</li>
      <li>فضای آزاد ≤ ${formatVal(LIMITS_T.FREE_MAX,'thou')} (~${formatVal(LIMITS_T.FREE_MAX,'mm')})</li>
      <li>درصد درگیری ≥ ${LIMITS_T.OL_MIN}%</li>
    </ul>
    <h5>۵. پشتیبانی</h5>
    <ul>
      <li>ایمیل: <a href="mailto:mosayeb872@gmail.com">mosayeb872@gmail.com</a></li>
      <li>© ۲۰۲۵ کارخانه یک‌و‌یک</li>
    </ul>
    <button id="helpCloseBtn">بستن</button>
  `;
  const helpBox = document.getElementById('helpBox');
  helpBox.innerHTML = helpHTML;
  document.getElementById('helpOverlay').style.display = 'flex';
  document.getElementById('helpCloseBtn').onclick = () => {
    document.getElementById('helpOverlay').style.display = 'none';
  };
}

updateProgress();
</script>

</body>
</html>
